// AI-tutor-v1.0/ai translation/üìö Vocabulary/Views/VocabularyHomeView.swift

import SwiftUI

struct VocabularyHomeView: View {
    @StateObject private var vocabularyService = VocabularyService()
    @State private var statistics: VocabularyStatistics?
    @State private var isLoading = true
    @State private var errorMessage: String?
    @State private var showingStudyModeSelection = false
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 20) {
                    // È†ÇÈÉ®Áµ±Ë®àÂç°Áâá
                    if let stats = statistics {
                        statisticsSection(stats)
                    } else if isLoading {
                        loadingSection
                    } else {
                        errorSection
                    }
                    
                    // ‰ªäÊó•Âæ©ÁøíË®àÂäÉ
                    dailyPlanSection
                    
                    // Âø´ÈÄüÂ≠∏ÁøíÊ®°ÂºèÈÅ∏Êìá
                    quickStudySection
                    
                    // ÈÄ≤Â∫¶ÂúñË°®
                    if let stats = statistics {
                        progressSection(stats)
                    }
                    
                    Spacer()
                }
                .padding()
            }
            .navigationTitle("üìö ÂñÆÂ≠óÂ∫´")
            .refreshable {
                await loadStatistics()
            }
        }
        .task {
            await loadStatistics()
        }
        .sheet(isPresented: $showingStudyModeSelection) {
            StudyModeSelectionView()
        }
    }
    
    // MARK: - Áµ±Ë®àÂçÄÂüü
    
    private func statisticsSection(_ stats: VocabularyStatistics) -> some View {
        VStack(spacing: 16) {
            // ‰∏ªË¶ÅÁµ±Ë®à
            HStack(spacing: 20) {
                StatCard(
                    title: "Á∏ΩÂñÆÂ≠ó",
                    value: "\(stats.totalWords)",
                    color: Color.blue,
                    icon: "book.fill"
                )
                
                StatCard(
                    title: "Â∑≤ÊéåÊè°",
                    value: "\(stats.masteredWords)",
                    color: Color.green,
                    icon: "checkmark.circle.fill"
                )
                
                StatCard(
                    title: "‰ªäÊó•Ë§áÁøí",
                    value: "\(stats.dueToday)",
                    color: Color.orange,
                    icon: "clock.fill"
                )
            }
            
            // ÊéåÊè°Â∫¶ÈÄ≤Â∫¶Ê¢ù
            VStack(alignment: .leading, spacing: 8) {
                HStack {
                    Text("Êï¥È´îÊéåÊè°Â∫¶")
                        .font(.appHeadline(for: "Êï¥È´îÊéåÊè°Â∫¶"))
                        .foregroundColor(.primary)
                    
                    Spacer()
                    
                    Text("\(String(format: "%.1f", stats.masteryPercentage))%")
                        .font(.appTitle2())
                        .foregroundColor(.green)
                }
                
                ProgressView(value: stats.masteryPercentage / 100.0)
                    .progressViewStyle(LinearProgressViewStyle(tint: .green))
                    .scaleEffect(x: 1, y: 2, anchor: .center)
                
                HStack {
                    Label("\(stats.newWords) Êñ∞ÂñÆÂ≠ó", systemImage: "plus.circle")
                        .font(.appCaption())
                        .foregroundColor(.blue)
                    
                    Spacer()
                    
                    Label("\(stats.learningWords) Â≠∏Áøí‰∏≠", systemImage: "clock.circle")
                        .font(.appCaption())
                        .foregroundColor(.orange)
                }
            }
            .padding()
            .background(Color(.systemGray6))
            .cornerRadius(12)
        }
    }
    
    // MARK: - ‰ªäÊó•Ë®àÂäÉ
    
    private var dailyPlanSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack {
                Image(systemName: "calendar.badge.clock")
                    .foregroundColor(.orange)
                Text("‰ªäÊó•Âæ©ÁøíË®àÂäÉ")
                    .font(.appHeadline())
                                    
                Spacer()
                
                if let stats = statistics, stats.dueToday > 0 {
                    Text("\(stats.dueToday)ÂÄãÂñÆÂ≠óÂæÖË§áÁøí")
                        .font(.appCaption())
                        .foregroundColor(.orange)
                        .padding(.horizontal, 8)
                        .padding(.vertical, 4)
                        .background(Color.orange.opacity(0.1))
                        .cornerRadius(8)
                }
            }
            
            if let stats = statistics {
                if stats.dueToday > 0 {
                    Button(action: {
                        // Áõ¥Êé•ÈñãÂßãË§áÁøíÊ®°Âºè
                        showingStudyModeSelection = true
                    }) {
                        HStack {
                            Image(systemName: "play.circle.fill")
                            Text("ÈñãÂßã‰ªäÊó•Ë§áÁøí")
                            Spacer()
                            Image(systemName: "chevron.right")
                        }
                        .foregroundColor(.white)
                        .padding()
                        .background(Color.orange)
                        .cornerRadius(12)
                    }
                } else {
                    HStack {
                        Image(systemName: "checkmark.circle.fill")
                            .foregroundColor(.green)
                        Text("üéâ ‰ªäÊó•Âæ©ÁøíÂ∑≤ÂÆåÊàêÔºÅ")
                            .foregroundColor(.green)
                        Spacer()
                    }
                    .padding()
                    .background(Color.green.opacity(0.1))
                    .cornerRadius(12)
                }
            }
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(16)
        .shadow(color: .gray.opacity(0.1), radius: 2, x: 0, y: 1)
    }
    
    // MARK: - Âø´ÈÄüÂ≠∏Áøí
    
    private var quickStudySection: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack {
                Image(systemName: "bolt.circle")
                    .foregroundColor(.blue)
                Text("Âø´ÈÄüÂ≠∏Áøí")
                    .font(.appHeadline())
                                }
            
            LazyVGrid(columns: [
                GridItem(.flexible()),
                GridItem(.flexible())
            ], spacing: 12) {
                StudyModeButton(
                    mode: .review,
                    action: { showingStudyModeSelection = true }
                )
                
                StudyModeButton(
                    mode: .newLearning,
                    action: { showingStudyModeSelection = true }
                )
                
                StudyModeButton(
                    mode: .targeted,
                    action: { showingStudyModeSelection = true }
                )
                
                NavigationLink(destination: Text("ÂñÆÂ≠óÁÆ°ÁêÜ")) {
                    VStack {
                        Image(systemName: "list.bullet.rectangle")
                            .font(.appTitle2())
                            .foregroundColor(.gray)
                        Text("ÂñÆÂ≠óÁÆ°ÁêÜ")
                            .font(.appCaption())
                                                        .foregroundColor(.gray)
                    }
                    .frame(maxWidth: .infinity)
                    .frame(height: 80)
                    .background(Color(.systemGray6))
                    .cornerRadius(12)
                }
            }
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(16)
        .shadow(color: .gray.opacity(0.1), radius: 2, x: 0, y: 1)
    }
    
    // MARK: - ÈÄ≤Â∫¶ÂúñË°®
    
    private func progressSection(_ stats: VocabularyStatistics) -> some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack {
                Image(systemName: "chart.pie")
                    .foregroundColor(.purple)
                Text("Â≠∏ÁøíÈÄ≤Â∫¶ÂàÜÂ∏É")
                    .font(.appHeadline())
                                }
            
            // Á∞°ÂåñÁöÑÈÄ≤Â∫¶ÂúìÁí∞
            HStack(spacing: 20) {
                VStack {
                    ZStack {
                        Circle()
                            .stroke(Color.gray.opacity(0.3), lineWidth: 8)
                            .frame(width: 80, height: 80)
                        
                        Circle()
                            .trim(from: 0, to: CGFloat(stats.masteredWords) / max(CGFloat(stats.totalWords), 1))
                            .stroke(Color.green, style: StrokeStyle(lineWidth: 8, lineCap: .round))
                            .frame(width: 80, height: 80)
                            .rotationEffect(.degrees(-90))
                        
                        Text("\(stats.masteredWords)")
                            .font(.appHeadline())
                                                }
                    
                    Text("Â∑≤ÊéåÊè°")
                        .font(.appCaption())
                        .foregroundColor(.green)
                }
                
                VStack(alignment: .leading, spacing: 4) {
                    ProgressBar(
                        title: "Êñ∞ÂñÆÂ≠ó",
                        count: stats.newWords,
                        total: stats.totalWords,
                        color: .blue
                    )
                    
                    ProgressBar(
                        title: "Â≠∏Áøí‰∏≠",
                        count: stats.learningWords,
                        total: stats.totalWords,
                        color: .orange
                    )
                    
                    ProgressBar(
                        title: "Â∑≤ÊéåÊè°",
                        count: stats.masteredWords,
                        total: stats.totalWords,
                        color: .green
                    )
                }
                
                Spacer()
            }
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(16)
        .shadow(color: .gray.opacity(0.1), radius: 2, x: 0, y: 1)
    }
    
    // MARK: - ËºâÂÖ•ÂíåÈåØË™§ÁãÄÊÖã
    
    private var loadingSection: some View {
        VStack(spacing: 16) {
            ProgressView()
                .scaleEffect(1.5)
            Text("ËºâÂÖ•Áµ±Ë®àË≥áÊñô‰∏≠...")
                .foregroundColor(.gray)
        }
        .frame(height: 200)
    }
    
    private var errorSection: some View {
        VStack(spacing: 16) {
            Image(systemName: "exclamationmark.triangle")
                .font(.appLargeTitle())
                .foregroundColor(.orange)
            
            Text("ËºâÂÖ•Â§±Êïó")
                .font(.appHeadline())
            
            if let error = errorMessage {
                Text(error)
                    .font(.appCaption())
                    .foregroundColor(.gray)
                    .multilineTextAlignment(.center)
            }
            
            Button("ÈáçÊñ∞ËºâÂÖ•") {
                Task {
                    await loadStatistics()
                }
            }
            .buttonStyle(.bordered)
        }
        .frame(height: 200)
    }
    
    // MARK: - ÊñπÊ≥ï
    
    private func loadStatistics() async {
        isLoading = true
        errorMessage = nil
        
        do {
            statistics = try await vocabularyService.getStatistics()
        } catch {
            errorMessage = error.localizedDescription
        }
        
        isLoading = false
    }
}

// MARK: - ËºîÂä©ÂÖÉ‰ª∂

struct StatCard: View {
    let title: String
    let value: String
    let color: Color
    let icon: String
    
    var body: some View {
        VStack(spacing: 8) {
            Image(systemName: icon)
                .font(.appTitle2())
                .foregroundColor(color)
            
            Text(value)
                .font(.appTitle2())
                                .foregroundColor(.primary)
            
            Text(title)
                .font(.appCaption())
                .foregroundColor(.gray)
                .multilineTextAlignment(.center)
        }
        .frame(maxWidth: .infinity)
        .padding(.vertical, 16)
        .background(Color(.systemGray6))
        .cornerRadius(12)
    }
}

struct StudyModeButton: View {
    let mode: StudyMode
    let action: () -> Void
    
    var body: some View {
        Button(action: action) {
            VStack {
                Image(systemName: mode.systemImageName)
                    .font(.appTitle2())
                    .foregroundColor(.blue)
                
                Text(mode.displayName)
                    .font(.appCaption())
                                        .foregroundColor(.primary)
                    .multilineTextAlignment(.center)
            }
            .frame(maxWidth: .infinity)
            .frame(height: 80)
            .background(Color(.systemGray6))
            .cornerRadius(12)
        }
    }
}

struct ProgressBar: View {
    let title: String
    let count: Int
    let total: Int
    let color: Color
    
    private var percentage: Double {
        guard total > 0 else { return 0 }
        return Double(count) / Double(total)
    }
    
    var body: some View {
        VStack(alignment: .leading, spacing: 4) {
            HStack {
                Text(title)
                    .font(.appCaption())
                    .foregroundColor(.gray)
                
                Spacer()
                
                Text("\(count)")
                    .font(.appCaption())
                                        .foregroundColor(color)
            }
            
            GeometryReader { geometry in
                ZStack(alignment: .leading) {
                    Rectangle()
                        .fill(Color.gray.opacity(0.2))
                        .frame(height: 4)
                        .cornerRadius(2)
                    
                    Rectangle()
                        .fill(color)
                        .frame(width: geometry.size.width * percentage, height: 4)
                        .cornerRadius(2)
                }
            }
            .frame(height: 4)
        }
    }
}
